<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behind-the-Meter Solar PPA Simulator (Investor & Customer View)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 90%;
            margin: auto;
        }
        /* Custom styling for inputs and buttons for a modern look */
        input[type="number"], input[type="text"], input[type="date"], select {
            border-radius: 0.5rem; /* rounded corners */
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* light gray border */
            width: 100%;
        }
        button {
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600; /* semi-bold */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        button:hover {
            opacity: 0.9;
        }
        .table-auto {
            width: 100%;
            border-collapse: collapse;
        }
        .table-auto th, .table-auto td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* light gray border */
        }
        .table-auto th {
            background-color: #e0f2fe; /* light blue */
            font-weight: 600;
        }
        /* Styles for IRR conditional coloring */
        .irr-red {
            color: #dc2626; /* red-600 */
        }
        .irr-green {
            color: #16a34a; /* green-600 */
        }

        /* Styles for print output */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: 100%;
                width: 100%;
                box-shadow: none !important;
                padding: 0;
                display: block; /* Ensure it's block for full width */
            }
            .lg\:flex-row {
                flex-direction: column !important;
            }
            .gap-8, .lg\:gap-12 {
                gap: 1rem !important;
            }

            /* --- Base print styles: Hide non-essential elements --- */
            .input-section, 
            #printFullReportBtn, /* Specific button IDs */
            #printCustomerReportBtn,
            .add-remove-btn, 
            #getInsightsBtn, 
            #insightsOutput {
                display: none !important;
            }
            
            .results-section {
                display: block !important;
                width: 100% !important;
                max-height: none !important;
                overflow-y: visible !important;
                background-color: #fff !important;
                box-shadow: none !important;
                padding: 0 1rem !important; /* Add some padding for readability */
            }

            /* --- Specific print modes --- */

            /* Print Mode: Full Report (default for window.print()) */
            body.print-full-report .input-section {
                display: block !important; /* Show inputs for full report */
                width: 100% !important;
                padding: 0 1rem !important;
            }
            body.print-full-report .input-section h1,
            body.print-full-report .input-section p {
                text-align: left !important; /* Align text left in print */
            }
            body.print-full-report .input-section label {
                width: auto !important; /* Allow labels to size naturally */
                display: block !important; /* Ensure labels are on their own line */
            }
            body.print-full-report .input-section input,
            body.print-full-report .input-section select {
                border: none !important; /* Remove borders */
                padding: 0 !important;
                width: auto !important; /* Prevent stretching */
                background: transparent !important;
            }
            body.print-full-report .input-section .space-y-6 > div {
                display: flex !important;
                justify-content: space-between !important;
                padding: 0.2rem 0 !important;
                border-bottom: 1px dashed #eee; /* Light separator */
                font-size: 0.9em;
            }
            body.print-full-report .input-section .space-y-6 > div:last-of-type {
                border-bottom: none;
            }
            body.print-full-report .input-section .space-y-6 > div > label {
                 flex-basis: 70%; /* Give label more space */
                 font-weight: 500;
            }
            body.print-full-report .input-section .space-y-6 > div > input,
            body.print-full-report .input-section .space-y-6 > div > select {
                flex-basis: 30%; /* Value smaller */
                text-align: right;
            }
            body.print-full-report .input-section p.text-xs {
                display: none; /* Hide small help text in print */
            }
            body.print-full-report #dynamicOtherCostsContainer {
                border: none !important;
                background-color: transparent !important;
                padding: 0 !important;
            }
            body.print-full-report #dynamicOtherCostsContainer h4 {
                font-size: 1.1em;
                margin-top: 1em;
            }
            body.print-full-report .other-annual-cost-row {
                flex-direction: row !important;
                justify-content: space-between !important;
                border-bottom: 1px dashed #eee;
                padding: 0.2rem 0 !important;
                font-size: 0.9em;
            }
            body.print-full-report .other-annual-cost-row > div {
                width: auto !important;
                margin-right: 0.5rem;
                padding: 0 !important;
            }
            body.print-full-report .other-annual-cost-row input, 
            body.print-full-report .other-annual-cost-row select {
                border: none !important;
                background-color: transparent !important;
                text-align: right;
                font-size: 1em;
            }
            body.print-full-report .other-annual-cost-row label {
                display: none !important; /* Hide labels inside dynamic rows */
            }
            body.print-full-report .other-annual-cost-row input[type="text"] {
                text-align: left; /* Description should remain left-aligned */
            }


            /* Print Mode: Customer Report */
            body.print-customer-report .input-section {
                display: none !important; /* Hide input section */
            }
            /* Hide investor-specific sections */
            body.print-customer-report .summary-investor-section, 
            body.print-customer-report #investorCashFlowChart { 
                display: none !important;
            }
            /* Show customer-specific sections */
            body.print-customer-report .customer-financials-section,
            body.print-customer-report .system-buyout-section { /* Show buyout for customer report */
                display: block !important; 
                width: 100% !important;
                max-height: none !important;
                overflow-y: visible !important;
                background-color: #fff !important;
                box-shadow: none !important;
                padding: 0 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white shadow-xl rounded-xl p-8 md:p-12 lg:p-16 flex flex-col lg:flex-row gap-8 lg:gap-12 w-full max-w-7xl">
        <!-- Simulator Input Section -->
        <div class="lg:w-1/2 input-section">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center lg:text-left">BTM Solar PPA Simulator (Investor & Customer View)</h1>
            <p class="text-gray-600 mb-8 leading-relaxed">
                Model the financial returns of a Behind-the-Meter Solar Power Purchase Agreement from an investor's perspective.
                Enter your project details to estimate ROI and IRR.
            </p>

            <div class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Project Information</h3>
                <!-- Project Name -->
                <div>
                    <label for="projectName" class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                    <input type="text" id="projectName" value="My Solar PPA Project" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Date -->
                <div>
                    <label for="projectDate" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" id="projectDate" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Solar System Details</h3>
                <!-- System Size -->
                <div>
                    <label for="systemSize" class="block text-sm font-medium text-gray-700 mb-2">System Size (kW)</label>
                    <input type="number" id="systemSize" value="100" min="1" step="1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Daily Average Solar Generation Per kW -->
                <div>
                    <label for="dailyAvgSolarGenerationPerKw" class="block text-sm font-medium text-gray-700 mb-2">Daily Average Solar Generation (kWh/kW/day)</label>
                    <input type="number" id="dailyAvgSolarGenerationPerKw" value="3.56" min="1" step="0.01" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- System Degradation Rate -->
                <div>
                    <label for="systemDegradationRate" class="block text-sm font-medium text-gray-700 mb-2">Annual System Degradation Rate (%)</label>
                    <input type="number" id="systemDegradationRate" value="0.5" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">PPA and Energy Sale Details</h3>
                <!-- Initial PPA Price -->
                <div>
                    <label for="initialPPAPrice" class="block text-sm font-medium text-gray-700 mb-2">Initial PPA Price for Customer Consumption ($/kWh)</label>
                    <input type="number" id="initialPPAPrice" value="0.10" min="0.01" step="0.001" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- PPA Escalation Rate -->
                <div>
                    <label for="ppaEscalationRate" class="block text-sm font-medium text-gray-700 mb-2">Annual PPA Price Escalation Rate (%)</label>
                    <input type="number" id="ppaEscalationRate" value="1.5" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Initial Export Price -->
                <div>
                    <label for="initialExportPrice" class="block text-sm font-medium text-gray-700 mb-2">Initial Export Price ($/kWh)</label>
                    <input type="number" id="initialExportPrice" value="0.03" min="0.001" step="0.001" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                 <!-- Export Price Escalation Rate -->
                <div>
                    <label for="exportPriceEscalationRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Export Price Escalation Rate (%)</label>
                    <input type="number" id="exportPriceEscalationRate" value="1" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- PPA Term -->
                <div>
                    <label for="ppaTerm" class="block text-sm font-medium text-gray-700 mb-2">PPA Term (Years)</label>
                    <input type="number" id="ppaTerm" value="20" min="5" step="1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Investor Financials</h3>
                <!-- Initial System Cost -->
                <div>
                    <label for="initialSystemCost" class="block text-sm font-medium text-gray-700 mb-2">Initial System Cost ($)</label>
                    <input type="number" id="initialSystemCost" value="150000" min="1000" step="1000" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Other Upfront Costs (e.g., Sales Commission) -->
                <div>
                    <label for="otherUpfrontCosts" class="block text-sm font-medium text-gray-700 mb-2">Other Upfront Costs (e.g., Sales Commission) ($)</label>
                    <input type="number" id="otherUpfrontCosts" value="5000" min="0" step="100" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Investor Annual O&M Cost -->
                <div>
                    <label for="investorOMRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Investor O&M Cost (% of Initial System Cost)</label>
                    <input type="number" id="investorOMRate" value="1" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                
                <!-- Dynamic Other Annual Costs Section - Heading moved here -->
                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Other Annual Costs</h3>
                <div id="dynamicOtherCostsContainer" class="space-y-4 border border-gray-300 rounded-md p-4 bg-gray-50">
                    <!-- Cost item template will be added here by JS -->
                </div>
                <button type="button" id="addOtherAnnualCostBtn" class="add-remove-btn w-full bg-blue-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    + Add Another Annual Cost
                </button>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Buyout Depreciation Rates</h3>
                <!-- Depreciation Rate (Years 1-5) -->
                <div>
                    <label for="depreciationRateYear1_5" class="block text-sm font-medium text-gray-700 mb-2">Depreciation Rate (Years 1-5) (%)</label>
                    <input type="number" id="depreciationRateYear1_5" value="2.5" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Depreciation Rate (Years 6-10) -->
                <div>
                    <label for="depreciationRateYear6_10" class="block text-sm font-medium text-gray-700 mb-2">Depreciation Rate (Years 6-10) (%)</label>
                    <input type="number" id="depreciationRateYear6_10" value="5" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Depreciation Rate (Years 11-15) -->
                <div>
                    <label for="depreciationRateYear11_15" class="block text-sm font-medium text-gray-700 mb-2">Depreciation Rate (Years 11-15) (%)</label>
                    <input type="number" id="depreciationRateYear11_15" value="10" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Depreciation Rate (Years 16-20) -->
                <div>
                    <label for="depreciationRateYear16_20" class="block text-sm font-medium text-gray-700 mb-2">Depreciation Rate (Years 16-20) (%)</label>
                    <input type="number" id="depreciationRateYear16_20" value="20" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <!-- Discount Rate for NPV -->
                <div>
                    <label for="discountRate" class="block text-sm font-medium text-gray-700 mb-2">Discount Rate (%)</label>
                    <p class="text-xs text-gray-500 mb-2">Used for Net Present Value (NPV) calculation.</p>
                    <input type="number" id="discountRate" value="5" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <!-- Terminal Payment -->
                <div>
                    <label for="terminalPayment" class="block text-sm font-medium text-gray-700 mb-2">Terminal Payment at End of PPA Term ($)</label>
                    <p class="text-xs text-gray-500 mb-2">Defaulted to the system's last buyout price. Included in IRR/NPV.</p>
                    <input type="number" id="terminalPayment" value="0" min="0" step="100" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 pb-2">Customer Consumption Profile</h3>
                <!-- Customer Self-Consumption Percentage -->
                <div>
                    <label for="customerSelfConsumptionPercentage" class="block text-sm font-medium text-gray-700 mb-2">Customer Self-Consumption Percentage of Solar Production (%)</label>
                    <p class="text-xs text-gray-500 mb-2">This is the percentage of generated solar energy the customer consumes directly. The remaining percentage will be considered 'exported energy'.</p>
                    <input type="number" id="customerSelfConsumptionPercentage" value="80" min="0" max="100" step="1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                 <!-- Customer Annual Electricity Consumption -->
                <div>
                    <label for="customerAnnualConsumption" class="block text-sm font-medium text-gray-700 mb-2">Customer's Annual Electricity Consumption (kWh/year)</label>
                    <input type="number" id="customerAnnualConsumption" value="150000" min="1000" step="1000" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Current Grid Electricity Price -->
                <div>
                    <label for="currentGridPrice" class="block text-sm font-medium text-gray-700 mb-2">Current Grid Electricity Price ($/kWh)</label>
                    <input type="number" id="currentGridPrice" value="0.15" min="0.01" step="0.01" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Grid Electricity Price Inflation Rate -->
                <div>
                    <label for="gridInflationRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Grid Electricity Price Inflation Rate (%)</label>
                    <input type="number" id="gridInflationRate" value="3" min="0" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                <!-- Customer Feed-in Tariff -->
                <div>
                    <label for="customerFeedInTariff" class="block text-sm font-medium text-gray-700 mb-2">Customer Feed-in Tariff ($/kWh Exported by Customer)</label>
                    <p class="text-xs text-gray-500 mb-2">Revenue customer receives for energy exported to the grid (if customer owns the system).</p>
                    <input type="number" id="customerFeedInTariff" value="0.00" min="0.00" step="0.001" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                </div>
                
                <!-- Calculate Button -->
                <button id="calculateBtn" class="w-full bg-blue-600 text-white py-3 rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                    Calculate PPA Financials
                </button>
            </div>
        </div>

        <!-- Results Display Section -->
        <div class="lg:w-1/2 bg-blue-50 p-8 rounded-lg shadow-inner flex flex-col max-h-screen overflow-y-auto results-section">
            <h2 class="text-3xl font-bold text-blue-800 mb-6 text-center summary-investor-section customer-financials-section">Project Financials Estimate</h2>
            <div id="projectInfo" class="text-gray-700 text-center mb-6">
                <p class="text-xl font-semibold"><span id="displayProjectName"></span></p>
                <p class="text-md text-gray-600"><span id="displayProjectDate"></span></p>
            </div>
            <div id="results" class="space-y-4 text-gray-700">
                <div class="summary-investor-section">
                    <p class="text-lg"><span class="font-semibold text-blue-700">Project IRR:</span> <span id="projectIRRResult">0.00%</span> <span id="irrDisclaimer" class="text-sm font-medium"></span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Investor ROI:</span> <span id="investorROIResult">0.00%</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Net Present Value (NPV):</span> <span id="netPresentValueResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Payback Period:</span> <span id="paybackPeriodResult">N/A</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Levelized Cost of Energy (LCOE):</span> <span id="lcoeResult">$0.00/kWh</span></p>
                    
                    <hr class="my-6 border-t-2 border-blue-200"> <!-- Separator -->

                    <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Summary of Investor Cash Flows and Energy</h3>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Initial Total Investment:</span> <span id="initialTotalInvestmentResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Year 1 Net Return:</span> <span id="year1NetReturnResult">$0.00</span></p> 
                    <p class="text-lg"><span class="font-semibold text-blue-700">Year 1 Return Percentage:</span> <span id="year1ReturnPercentageResult">0.00%</span></p> 
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Solar Energy Generated (over PPA Term):</span> <span id="totalSolarEnergyGeneratedResult">0 kWh</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Solar Energy Sold to Customer:</span> <span id="totalSolarEnergySoldToCustomerResult">0 kWh</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Solar Energy Exported:</span> <span id="totalSolarEnergyExportedResult">0 kWh</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total PPA Revenue from Customer:</span> <span id="totalPPARevenueCustomerResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Revenue from Export:</span> <span id="totalExportRevenueResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Investor O&M Cost:</span> <span id="totalInvestorOMCostResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Total Other Annual Costs:</span> <span id="totalOtherAnnualCostsResult">$0.00</span></p> <!-- Consolidated total -->
                    <p class="text-lg"><span class="font-semibold text-blue-700">Net Profit for Investor:</span> <span id="netProfitForInvestorResult">$0.00</span></p>
                    <p class="text-lg"><span class="font-semibold text-blue-700">Terminal Payment:</span> <span id="terminalPaymentResult">$0.00</span></p> <!-- New output for terminal payment -->
                </div>
                
                <hr class="my-6 border-t-2 border-blue-200"> <!-- Separator -->

                <h3 class="text-xl font-semibold text-blue-700 mb-6 text-center customer-financials-section">Customer Financials Estimate</h3>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Total Customer Grid Cost (without solar):</span> <span id="totalCustomerGridCostNoSolarResult">$0.00</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Total Solar PPA Cost for Customer:</span> <span id="totalSolarPPACostForCustomerResult">$0.00</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Total Customer Grid Cost (with solar):</span> <span id="totalCustomerGridCostWithSolarResult">$0.00</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Total Savings for Customer:</span> <span id="totalSavingsForCustomerResult">$0.00</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Average Annual Savings for Customer:</span> <span id="averageAnnualSavingsForCustomerResult">$0.00</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Savings per kWh for Customer:</span> <span id="savingsPerKwhForCustomerResult">$0.00/kWh</span></p>
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Percentage Saved per kWh for Customer:</span> <span id="percentageSavedPerKwhForCustomerResult">0.00%</span></p> 
                <p class="text-lg customer-financials-section"><span class="font-semibold text-blue-700">Total Customer Export Revenue:</span> <span id="totalCustomerExportRevenueResult">$0.00</span></p> 

                <hr class="my-6 border-t-2 border-blue-200 system-buyout-section"> <!-- Separator -->

                <h3 class="text-xl font-semibold text-blue-700 mb-2 text-center system-buyout-section">System Buyout Schedule</h3>
                <p class="text-sm text-gray-600 mb-4 text-center system-buyout-section" id="buyoutDepreciationDescription">
                    (Initial Buyout Value = Initial System Cost + 20% Premium. Depreciation rates are user-defined for specific periods.)
                </p>
                <div id="buyoutScheduleTableContainer" class="overflow-x-auto rounded-lg shadow system-buyout-section">
                    <table class="table-auto min-w-full">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Buyout Value</th>
                            </tr>
                        </thead>
                        <tbody id="buyoutScheduleTableBody">
                            <!-- Buyout schedule will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="investorCashFlowChart" class="mt-8 summary-investor-section">
                    <h3 class="text-xl font-semibold text-blue-700 mb-4 text-center">Projected Annual Investor Net Cash Flow</h3>
                    <!-- Fixed height wrapper for the canvas -->
                    <div class="relative w-full h-64">
                        <canvas id="cashFlowChart" class="absolute inset-0"></canvas>
                    </div>
                </div>
                <!-- Gemini API Integration Button -->
                <button id="getInsightsBtn" class="w-full bg-purple-600 text-white py-3 mt-8 rounded-md shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                    ✨ Get Project Insights
                </button>
                <div id="insightsOutput" class="mt-4 p-4 bg-purple-50 rounded-lg text-gray-800 text-sm italic">
                    <!-- LLM generated insights will appear here -->
                    <p class="text-center text-gray-500">Click "✨ Get Project Insights" to analyze the project financials.</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mt-8">
                    <button id="printFullReportBtn" class="flex-1 bg-green-600 text-white py-3 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                        Print Full Report
                    </button>
                    <button id="printCustomerReportBtn" class="flex-1 bg-indigo-600 text-white py-3 rounded-md shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                        Print Customer Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js CDN for plotting results -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Get references to static elements that are only initialized once and not prone to being null
        const calculateBtn = document.getElementById('calculateBtn');
        const getInsightsBtn = document.getElementById('getInsightsBtn'); 
        const insightsOutput = document.getElementById('insightsOutput'); 
        const dynamicOtherCostsContainer = document.getElementById('dynamicOtherCostsContainer');
        const addOtherAnnualCostBtn = document.getElementById('addOtherAnnualCostBtn');
        const printFullReportBtn = document.getElementById('printFullReportBtn'); 
        const printCustomerReportBtn = document.getElementById('printCustomerReportBtn'); 

        // Get references to result display elements
        const displayProjectName = document.getElementById('displayProjectName'); 
        const displayProjectDate = document.getElementById('displayProjectDate'); 
        const projectIRRResult = document.getElementById('projectIRRResult');
        const investorROIResult = document.getElementById('investorROIResult');
        const netPresentValueResult = document.getElementById('netPresentValueResult');
        const paybackPeriodResult = document.getElementById('paybackPeriodResult');
        const lcoeResult = document.getElementById('lcoeResult');
        const irrDisclaimer = document.getElementById('irrDisclaimer'); 
        const initialTotalInvestmentResult = document.getElementById('initialTotalInvestmentResult'); 
        const year1NetReturnResult = document.getElementById('year1NetReturnResult'); 
        const year1ReturnPercentageResult = document.getElementById('year1ReturnPercentageResult'); 
        const totalSolarEnergyGeneratedResult = document.getElementById('totalSolarEnergyGeneratedResult');
        const totalSolarEnergySoldToCustomerResult = document.getElementById('totalSolarEnergySoldToCustomerResult');
        const totalSolarEnergyExportedResult = document.getElementById('totalSolarEnergyExportedResult'); 
        const totalPPARevenueCustomerResult = document.getElementById('totalPPARevenueCustomerResult');
        const totalExportRevenueResult = document.getElementById('totalExportRevenueResult');
        const totalInvestorOMCostResult = document.getElementById('totalInvestorOMCostResult');
        const totalOtherAnnualCostsResult = document.getElementById('totalOtherAnnualCostsResult'); 
        const netProfitForInvestorResult = document.getElementById('netProfitForInvestorResult');
        const terminalPaymentResult = document.getElementById('terminalPaymentResult'); 
        const totalCustomerGridCostNoSolarResult = document.getElementById('totalCustomerGridCostNoSolarResult'); 
        const totalSolarPPACostForCustomerResult = document.getElementById('totalSolarPPACostForCustomerResult'); 
        const totalCustomerGridCostWithSolarResult = document.getElementById('totalCustomerGridCostWithSolarResult'); 
        const totalSavingsForCustomerResult = document.getElementById('totalSavingsForCustomerResult'); 
        const averageAnnualSavingsForCustomerResult = document.getElementById('averageAnnualSavingsForCustomerResult'); 
        const savingsPerKwhForCustomerResult = document.getElementById('savingsPerKwhForCustomerResult'); 
        const percentageSavedPerKwhForCustomerResult = document.getElementById('percentageSavedPerKwhForCustomerResult'); 
        const totalCustomerExportRevenueResult = document.getElementById('totalCustomerExportRevenueResult'); 
        const buyoutScheduleTableBody = document.getElementById('buyoutScheduleTableBody'); 
        const cashFlowChartCanvas = document.getElementById('cashFlowChart');
        let cashFlowChart; 

        // Initial dynamic cost entries (e.g., roof rental, partners fee)
        const initialDynamicCosts = [
            { id: 1, type: 'fixed', value: 1000, label: 'Roof Rental' },
            { id: 2, type: 'per_kwh_sold', value: 0.005, label: 'Partners Fee' },
            { id: 3, type: 'fixed', value: 200, label: 'Metering Fees' }
        ];
        let dynamicCostCounter = initialDynamicCosts.length; // Counter for unique IDs

        // Function to set today's date
        function setTodayDate() {
            const today = new Date();
            const year = today.getFullYear(); 
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            const day = String(today.getDate()).padStart(2, '0');
            const projectDateInput = document.getElementById('projectDate');
            if (projectDateInput) {
                projectDateInput.value = `${year}-${month}-${day}`;
            }
        }

        /**
         * Renders a new dynamic annual cost input row.
         * @param {Object} [cost={}] - Optional initial cost data to pre-populate the row.
         */
        function renderOtherAnnualCostRow(cost = {}) {
            const newId = cost.id || ++dynamicCostCounter;
            const costValue = cost.value !== undefined ? cost.value : 0;
            const costType = cost.type || 'fixed';
            const costLabel = cost.label || `Other Annual Cost ${newId}`;

            const costRow = document.createElement('div');
            costRow.classList.add('flex', 'flex-col', 'md:flex-row', 'gap-2', 'items-center', 'other-annual-cost-row');
            costRow.setAttribute('data-id', newId);

            costRow.innerHTML = `
                <div class="w-full md:w-1/2">
                    <label for="otherAnnualCostLabel_${newId}" class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="otherAnnualCostLabel_${newId}" value="${costLabel}"
                           class="w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="w-full md:w-1/4">
                    <label for="otherAnnualCostValue_${newId}" class="block text-xs font-medium text-gray-700 mb-1">Value</label>
                    <input type="number" id="otherAnnualCostValue_${newId}" value="${costValue}" step="any"
                           class="w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="w-full md:w-1/4">
                    <label for="otherAnnualCostType_${newId}" class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                    <select id="otherAnnualCostType_${newId}"
                            class="w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="fixed" ${costType === 'fixed' ? 'selected' : ''}>Fixed $ per year</option>
                        <option value="per_kwh_sold" ${costType === 'per_kwh_sold' ? 'selected' : ''}>$/kWh sold to customer</option>
                        <option value="percent_initial_cost" ${costType === 'percent_initial_cost' ? 'selected' : ''}>% of Initial System Cost</option>
                        <option value="per_kw_installed" ${costType === 'per_kw_installed' ? 'selected' : ''}>$ per kW installed</option>
                        <option value="percent_of_profit" ${costType === 'percent_of_profit' ? 'selected' : ''}>% of Profit (before this cost)</option>
                    </select>
                </div>
                <button type="button" class="remove-other-annual-cost-btn add-remove-btn text-red-600 hover:text-red-800 text-2xl font-bold p-1">
                    &times;
                </button>
            `;
            dynamicOtherCostsContainer.appendChild(costRow);

            // Add event listener for remove button
            costRow.querySelector('.remove-other-annual-cost-btn').addEventListener('click', () => {
                costRow.remove();
            });
        }

        // Event listener for "Add Another Annual Cost" button
        addOtherAnnualCostBtn.addEventListener('click', () => {
            renderOtherAnnualCostRow();
        });


        /**
         * Calculates the Internal Rate of Return (IRR) for a series of cash flows.
         * Uses a numerical approximation (bisection method).
         * @param {Array<number>} cashFlows - Array of cash flows, starting with initial investment (negative).
         * @returns {number} The IRR as a decimal, or NaN if not found.
         */
        function calculateIRR(cashFlows) {
            if (cashFlows.length === 0) return NaN;
            
            // Function to calculate Net Present Value (NPV) for a given rate
            const npv = (rate) => {
                let sum = 0;
                for (let i = 0; i < cashFlows.length; i++) {
                    sum += cashFlows[i] / Math.pow(1 + rate, i);
                }
                return sum;
            };

            const MAX_ITERATIONS = 1000;
            const EPSILON = 1e-6; // Tolerance for NPV to be close to zero

            let low = -0.99; 
            let high = 5.0; 

            // Check if a valid range for IRR exists
            if (npv(low) * npv(high) > 0) {
                 // Try expanding the range if initial bracket doesn't contain a root
                low = -0.999;
                high = 10.0;
                if (npv(low) * npv(high) > 0) {
                    return NaN; 
                }
            }


            for (let i = 0; i < MAX_ITERATIONS; i++) {
                let mid = (low + high) / 2;
                if (Math.abs(npv(mid)) < EPSILON) {
                    return mid;
                }

                if (npv(mid) * npv(low) < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            return NaN; 
        }

        /**
         * Calculates Net Present Value (NPV) for a series of cash flows at a given discount rate.
         * @param {Array<number>} cashFlows - Array of cash flows, starting with initial investment (negative).
         * @param {number} discountRate - The discount rate as a decimal (e.g., 0.05 for 5%).
         * @returns {number} The calculated NPV.
         */
        function calculateNPV(cashFlows, discountRate) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + discountRate, i);
            }
            return npv;
        }

        /**
         * Calculates the financial benefits and metrics for a BTM Solar PPA from an investor's view.
         * @returns {Object} An object containing all calculated results and data for charting.
         */
        function calculatePPADetails() {
            // Retrieve ALL input elements directly inside the function for maximum robustness
            const projectNameInput = document.getElementById('projectName'); 
            const projectDateInput = document.getElementById('projectDate'); 
            const systemSizeInput = document.getElementById('systemSize');
            const dailyAvgSolarGenerationPerKwInput = document.getElementById('dailyAvgSolarGenerationPerKw');
            const systemDegradationRateInput = document.getElementById('systemDegradationRate');
            const initialPPAPriceInput = document.getElementById('initialPPAPrice');
            const ppaEscalationRateInput = document.getElementById('ppaEscalationRate');
            const initialExportPriceInput = document.getElementById('initialExportPrice');
            const exportPriceEscalationRateInput = document.getElementById('exportPriceEscalationRate');
            const ppaTermInput = document.getElementById('ppaTerm');
            const initialSystemCostInput = document.getElementById('initialSystemCost');
            const otherUpfrontCostsInput = document.getElementById('otherUpfrontCosts'); 
            const investorOMRateInput = document.getElementById('investorOMRate');
            const depreciationRateYear1_5Input = document.getElementById('depreciationRateYear1_5'); 
            const depreciationRateYear6_10Input = document.getElementById('depreciationRateYear6_10'); 
            const depreciationRateYear11_15Input = document.getElementById('depreciationRateYear11_15'); 
            const depreciationRateYear16_20Input = document.getElementById('depreciationRateYear16_20'); 
            const discountRateInput = document.getElementById('discountRate');
            const terminalPaymentInput = document.getElementById('terminalPayment'); 
            const customerSelfConsumptionPercentageInput = document.getElementById('customerSelfConsumptionPercentage');
            const customerAnnualConsumptionInput = document.getElementById('customerAnnualConsumption'); 
            const currentGridPriceInput = document.getElementById('currentGridPrice'); 
            const gridInflationRateInput = document.getElementById('gridInflationRate'); 
            const customerFeedInTariffInput = document.getElementById('customerFeedInTariff'); 


            // Retrieve input values
            const systemSize = parseFloat(systemSizeInput.value); 
            const dailyAvgSolarGenerationPerKw = parseFloat(dailyAvgSolarGenerationPerKwInput.value); 
            const systemDegradationRate = parseFloat(systemDegradationRateInput.value) / 100; 
            let initialPPAPrice = parseFloat(initialPPAPriceInput.value); 
            const ppaEscalationRate = parseFloat(ppaEscalationRateInput.value) / 100; 
            let initialExportPrice = parseFloat(initialExportPriceInput.value); 
            const exportPriceEscalationRate = parseFloat(exportPriceEscalationRateInput.value) / 100; 
            const ppaTerm = parseInt(ppaTermInput.value); 
            const initialSystemCost = parseFloat(initialSystemCostInput.value); 
            const otherUpfrontCosts = parseFloat(otherUpfrontCostsInput.value); 
            const investorOMRate = parseFloat(investorOMRateInput.value) / 100; 
            const discountRate = parseFloat(discountRateInput.value) / 100;
            const customerSelfConsumptionPercentage = parseFloat(customerSelfConsumptionPercentageInput.value) / 100;
            const customerAnnualConsumption = parseFloat(customerAnnualConsumptionInput.value); 
            const currentGridPrice = parseFloat(currentGridPriceInput.value); 
            const gridInflationRate = parseFloat(gridInflationRateInput.value) / 100; 
            const customerFeedInTariff = parseFloat(customerFeedInTariffInput.value); 

            // Retrieve dynamic depreciation rates
            const depRate1_5 = parseFloat(depreciationRateYear1_5Input.value) / 100;
            const depRate6_10 = parseFloat(depreciationRateYear6_10Input.value) / 100;
            const depRate11_15 = parseFloat(depreciationRateYear11_15Input.value) / 100;
            const depRate16_20 = parseFloat(depreciationRateYear16_20Input.value) / 100;


            // Get dynamic other annual costs from the DOM
            const dynamicOtherCostRows = dynamicOtherCostsContainer.querySelectorAll('.other-annual-cost-row');
            const dynamicOtherCosts = Array.from(dynamicOtherCostRows).map(row => {
                const valueInput = row.querySelector('input[type="number"]');
                const typeSelect = row.querySelector('select');
                const labelInput = row.querySelector('input[type="text"]');

                const value = valueInput ? parseFloat(valueInput.value) : 0;
                const type = typeSelect ? typeSelect.value : 'fixed';
                const label = labelInput ? labelInput.value : 'Unknown Cost';

                return { value, type, label };
            });

            // Initialize totals for investor
            const initialTotalInvestment = initialSystemCost + otherUpfrontCosts; 
            let totalSolarEnergyGenerated = 0;
            let totalSolarEnergySoldToCustomer = 0;
            let totalSolarEnergyExported = 0;
            let totalPPARevenueCustomer = 0;
            let totalExportRevenue = 0;
            let totalInvestorOMCost = 0;
            let totalDynamicOtherCostsAccumulated = 0; 
            let cumulativeCashFlow = -initialTotalInvestment; 
            let paybackPeriod = 'N/A';
            let totalLifetimeCostsForLCOE = initialTotalInvestment; 
            let totalLifetimeEnergyProducedForLCOE = 0;
            
            const cashFlows = [-initialTotalInvestment]; // Start with initial negative cash flow
            const annualNetCashFlowData = [];
            const annualOtherCostsBreakdown = []; 
            const chartLabels = [];
            const buyoutSchedule = [];

            // Customer-side tracking
            let totalCustomerGridCostNoSolar = 0;
            let totalSolarPPACostForCustomer = 0;
            let totalCustomerGridCostWithSolar = 0;
            let totalSavingsForCustomer = 0;
            let totalCustomerExportRevenue = 0; 
            let year1NetReturn = 0; // Initialize Year 1 Net Return


            // Calculate fixed annual O&M cost for investor
            const annualFixedOMCostBase = initialSystemCost * investorOMRate; 

            // Calculate initial buyout value with 20% premium
            let currentBuyoutValue = initialSystemCost * 1.20; 

            // Loop through each year of the PPA term
            for (let year = 1; year <= ppaTerm; year++) {
                // Determine current buyout depreciation rate based on year from user inputs
                let currentBuyoutDepreciationRate;
                if (year >= 1 && year <= 5) {
                    currentBuyoutDepreciationRate = depRate1_5;
                } else if (year >= 6 && year <= 10) {
                    currentBuyoutDepreciationRate = depRate6_10;
                } else if (year >= 11 && year <= 15) {
                    currentBuyoutDepreciationRate = depRate11_15;
                } else if (year >= 16 && year <= 20) { // Assuming PPA term maxes out at 20 for these rates
                    currentBuyoutDepreciationRate = depRate16_20;
                } else {
                    currentBuyoutDepreciationRate = 0; // No depreciation after defined terms or if PPA term is longer
                }

                // Apply depreciation to buyout value for the current year (based on *previous* year's value)
                if (year > 1) { 
                    currentBuyoutValue *= (1 - currentBuyoutDepreciationRate);
                }
                currentBuyoutValue = Math.max(0, currentBuyoutValue); 
                buyoutSchedule.push({ year: year, value: currentBuyoutValue });


                // Calculate annual solar generation from daily average
                const annualSolarGeneration = systemSize * dailyAvgSolarGenerationPerKw * 365;

                // Adjust annual solar generation for degradation
                const effectiveSolarGeneration = annualSolarGeneration * (1 - systemDegradationRate)**(year - 1);
                
                // Energy consumed by customer and exported
                const consumedByCustomerSolarPPA = effectiveSolarGeneration * customerSelfConsumptionPercentage;
                const exportedEnergy = effectiveSolarGeneration * (1 - customerSelfConsumptionPercentage); 
                
                // Adjust PPA price for escalation
                const effectivePPAPrice = initialPPAPrice * (1 + ppaEscalationRate)**(year - 1);

                // Adjust Export price for escalation
                const effectiveExportPrice = initialExportPrice * (1 + exportPriceEscalationRate)**(year - 1);

                // Investor's annual revenue from customer consumption
                const investorAnnualRevenueCustomer = consumedByCustomerSolarPPA * effectivePPAPrice;

                // Investor's annual revenue from exported energy
                const investorAnnualRevenueExport = exportedEnergy * effectiveExportPrice;

                // Investor's total annual revenue
                const totalInvestorAnnualRevenue = investorAnnualRevenueCustomer + investorAnnualRevenueExport;

                // Calculate dynamic other annual costs for the current year
                let currentYearOtherCostsTotal = 0;
                
                let profitBaseForPercentOfProfit = totalInvestorAnnualRevenue - annualFixedOMCostBase; 

                // Pass 1: Calculate fixed, per_kwh_sold, percent_initial_cost, per_kw_installed
                dynamicOtherCosts.forEach(cost => {
                    let calculatedCost = 0;
                    if (cost.type !== 'percent_of_profit') {
                        switch (cost.type) {
                            case 'fixed':
                                calculatedCost = cost.value;
                                break;
                            case 'per_kwh_sold':
                                calculatedCost = cost.value * consumedByCustomerSolarPPA;
                                break;
                            case 'percent_initial_cost':
                                calculatedCost = cost.value / 100 * initialSystemCost;
                                break;
                            case 'per_kw_installed':
                                calculatedCost = cost.value * systemSize;
                                break;
                        }
                        currentYearOtherCostsTotal += calculatedCost;
                    }
                });

                // Adjust profit base for costs from Pass 1
                profitBaseForPercentOfProfit -= currentYearOtherCostsTotal;

                // Pass 2: Calculate % of profit costs based on the adjusted profit base
                dynamicOtherCosts.forEach(cost => {
                    if (cost.type === 'percent_of_profit') {
                        let calculatedCost = Math.max(0, profitBaseForPercentOfProfit) * (cost.value / 100);
                        currentYearOtherCostsTotal += calculatedCost;
                        profitBaseForPercentOfProfit -= calculatedCost; 
                    }
                });
                
                annualDynamicOtherCostsSum = currentYearOtherCostsTotal; 
                annualOtherCostsBreakdown.push({ year: year, value: annualDynamicOtherCostsSum }); // Store for breakdown table


                // Investor's total annual costs (O&M + all dynamic other annual costs)
                const totalAnnualOperatingCosts = annualFixedOMCostBase + annualDynamicOtherCostsSum;

                // Investor's annual net cash flow (total revenue minus all annual operating costs)
                const investorAnnualNetCashFlow = totalInvestorAnnualRevenue - totalAnnualOperatingCosts;

                // Capture Year 1 Net Return
                if (year === 1) {
                    year1NetReturn = investorAnnualNetCashFlow;
                }

                // Accumulate totals (Investor side)
                totalSolarEnergyGenerated += effectiveSolarGeneration;
                totalSolarEnergySoldToCustomer += consumedByCustomerSolarPPA;
                totalSolarEnergyExported += exportedEnergy;
                totalPPARevenueCustomer += investorAnnualRevenueCustomer;
                totalExportRevenue += investorAnnualRevenueExport;
                totalInvestorOMCost += annualFixedOMCostBase;
                totalDynamicOtherCostsAccumulated += annualDynamicOtherCostsSum; 
                
                totalLifetimeCostsForLCOE += totalAnnualOperatingCosts; 
                totalLifetimeEnergyProducedForLCOE += effectiveSolarGeneration;
                
                cashFlows.push(investorAnnualNetCashFlow);
                annualNetCashFlowData.push(investorAnnualNetCashFlow);
                chartLabels.push(`Year ${year}`);

                // Calculate Payback Period
                if (paybackPeriod === 'N/A') {
                    cumulativeCashFlow += investorAnnualNetCashFlow;
                    if (cumulativeCashFlow >= 0) {
                        const previousCumulativeCashFlow = cumulativeCashFlow - investorAnnualNetCashFlow;
                        if (investorAnnualNetCashFlow > 0) {
                            paybackPeriod = (year - 1) + (Math.abs(previousCumulativeCashFlow) / investorAnnualNetCashFlow);
                        } else {
                            paybackPeriod = 'N/A (No positive cash flow for payback)';
                        }
                    }
                }

                // --- Customer-side calculations for the current year ---
                const effectiveGridPrice = currentGridPrice * (1 + gridInflationRate)**(year - 1);
                
                const annualGridCostNoSolarThisYear = customerAnnualConsumption * effectiveGridPrice;
                const remainingGridPurchaseForCustomer = Math.max(0, customerAnnualConsumption - consumedByCustomerSolarPPA);
                const annualGridCostWithSolarThisYear = remainingGridPurchaseForCustomer * effectiveGridPrice;
                
                const annualSolarPPACostForCustomerThisYear = consumedByCustomerSolarPPA * effectivePPAPrice;
                
                // Customer receives revenue for exported energy
                const customerExportedEnergy = effectiveSolarGeneration - consumedByCustomerSolarPPA; 
                const customerAnnualExportRevenue = customerExportedEnergy * customerFeedInTariff; 


                const totalAnnualCustomerCostWithSolar = annualSolarPPACostForCustomerThisYear + annualGridCostWithSolarThisYear - customerAnnualExportRevenue; 
                const annualCustomerSavings = annualGridCostNoSolarThisYear - totalAnnualCustomerCostWithSolar;

                // Accumulate totals (Customer side)
                totalCustomerGridCostNoSolar += annualGridCostNoSolarThisYear;
                totalSolarPPACostForCustomer += annualSolarPPACostForCustomerThisYear;
                totalCustomerGridCostWithSolar += totalAnnualCustomerCostWithSolar;
                totalSavingsForCustomer += annualCustomerSavings;
                totalCustomerExportRevenue += customerAnnualExportRevenue; 
            }
            
            // Add Terminal Payment as a positive cash flow at the end of the PPA term
            const terminalPayment = parseFloat(terminalPaymentInput.value);
            if (!isNaN(terminalPayment) && ppaTerm > 0) {
                if (cashFlows.length === ppaTerm + 1) {
                   cashFlows[ppaTerm] += terminalPayment; 
                } else if (ppaTerm > 0) {
                   cashFlows.push(terminalPayment); 
                }
            }


            // Calculate Net Profit for Investor (includes all accumulated costs)
            const netProfitForInvestor = totalPPARevenueCustomer + totalExportRevenue - totalInvestorOMCost - totalDynamicOtherCostsAccumulated;
            const actualProfitAfterInvestment = netProfitForInvestor - initialTotalInvestment; 

            // Calculate Investor ROI
            const investorROI = initialTotalInvestment > 0 ? (actualProfitAfterInvestment / initialTotalInvestment) * 100 : 0;

            // Calculate Project IRR
            const projectIRR = calculateIRR(cashFlows) * 100; 

            // Calculate Net Present Value (NPV)
            const netPresentValue = calculateNPV(cashFlows, discountRate);

            // Calculate Levelized Cost of Energy (LCOE)
            const lcoe = totalLifetimeEnergyProducedForLCOE > 0 ? (totalLifetimeCostsForLCOE / totalLifetimeEnergyProducedForLCOE) : 0;

            // Calculate Savings per kWh for Customer - simplified as requested
            // This is the difference between the current grid price and the initial PPA price.
            const savingsPerKwhForCustomer = currentGridPrice - initialPPAPrice;
            const percentageSavedPerKwhForCustomer = (currentGridPrice > 0) ? (savingsPerKwhForCustomer / currentGridPrice) * 100 : 0;


            return {
                projectName: projectNameInput.value, 
                projectDate: projectDateInput.value, 
                initialTotalInvestment: initialTotalInvestment, 
                year1NetReturn: year1NetReturn, 
                year1ReturnPercentage: initialTotalInvestment > 0 ? (year1NetReturn / initialTotalInvestment) * 100 : 0, 
                totalSolarEnergyGenerated: totalSolarEnergyGenerated,
                totalSolarEnergySoldToCustomer: totalSolarEnergySoldToCustomer,
                totalSolarEnergyExported: totalSolarEnergyExported,
                totalPPARevenueCustomer: totalPPARevenueCustomer,
                totalExportRevenue: totalExportRevenue,
                totalInvestorOMCost: totalInvestorOMCost,
                totalOtherAnnualCosts: totalDynamicOtherCostsAccumulated, 
                netProfitForInvestor: actualProfitAfterInvestment,
                investorROI: investorROI,
                projectIRR: projectIRR,
                netPresentValue: netPresentValue,
                paybackPeriod: typeof paybackPeriod === 'number' ? paybackPeriod.toFixed(2) + ' years' : paybackPeriod,
                lcoe: lcoe,
                annualNetCashFlowData: annualNetCashFlowData,
                chartLabels: chartLabels,
                buyoutSchedule: buyoutSchedule,
                annualOtherCostsBreakdown: annualOtherCostsBreakdown, 
                // Customer-side results
                totalCustomerGridCostNoSolar: totalCustomerGridCostNoSolar,
                totalSolarPPACostForCustomer: totalSolarPPACostForCustomer,
                totalCustomerGridCostWithSolar: totalCustomerGridCostWithSolar,
                totalSavingsForCustomer: totalSavingsForCustomer,
                averageAnnualSavingsForCustomer: totalSavingsForCustomer / ppaTerm,
                savingsPerKwhForCustomer: savingsPerKwhForCustomer, 
                percentageSavedPerKwhForCustomer: percentageSavedPerKwhForCustomer, 
                totalCustomerExportRevenue: totalCustomerExportRevenue, 
                terminalPayment: terminalPayment 
            };
        }

        /**
         * Displays the calculated PPA financial results in the designated HTML elements.
         * Also updates the chart with investor's annual net cash flow.
         * @param {Object} results - The results object from calculatePPADetails.
         */
        function displayResults(results) {
            // Display project info
            displayProjectName.textContent = results.projectName;
            displayProjectDate.textContent = results.projectDate;

            // Display reordered relevant outputs (top financial metrics)
            projectIRRResult.textContent = `${results.projectIRR.toFixed(2)}%`;
            // Apply conditional styling and disclaimer for IRR
            const irrDisclaimerElement = document.getElementById('irrDisclaimer'); 
            if (results.projectIRR < 15) {
                projectIRRResult.classList.add('irr-red');
                projectIRRResult.classList.remove('irr-green');
                irrDisclaimerElement.textContent = ' (Less than required 15% IRR)'; 
            } else {
                projectIRRResult.classList.add('irr-green');
                projectIRRResult.classList.remove('irr-red');
                irrDisclaimerElement.textContent = ' (Meets or exceeds required 15% IRR)'; 
            }

            investorROIResult.textContent = `${results.investorROI.toFixed(2)}%`;
            netPresentValueResult.textContent = `$${results.netPresentValue.toFixed(2)}`;
            paybackPeriodResult.textContent = results.paybackPeriod;
            lcoeResult.textContent = `$${results.lcoe.toFixed(3)}/kWh`;
            
            // Display other outputs (summary of cash flows and energy)
            initialTotalInvestmentResult.textContent = `$${results.initialTotalInvestment.toFixed(2)}`;
            year1NetReturnResult.textContent = `$${results.year1NetReturn.toFixed(2)}`; 
            year1ReturnPercentageResult.textContent = `${results.year1ReturnPercentage.toFixed(2)}%`; 
            totalSolarEnergyGeneratedResult.textContent = `${results.totalSolarEnergyGenerated.toLocaleString(undefined, {maximumFractionDigits: 0})} kWh`;
            totalSolarEnergySoldToCustomerResult.textContent = `${results.totalSolarEnergySoldToCustomer.toLocaleString(undefined, {maximumFractionDigits: 0})} kWh`;
            totalSolarEnergyExportedResult.textContent = `${results.totalSolarEnergyExported.toLocaleString(undefined, {maximumFractionDigits: 0})} kWh`; 
            totalPPARevenueCustomerResult.textContent = `$${results.totalPPARevenueCustomer.toFixed(2)}`;
            totalExportRevenueResult.textContent = `$${results.totalExportRevenue.toFixed(2)}`;
            totalInvestorOMCostResult.textContent = `$${results.totalInvestorOMCost.toFixed(2)}`;
            totalOtherAnnualCostsResult.textContent = `$${results.totalOtherAnnualCosts.toFixed(2)}`; 
            netProfitForInvestorResult.textContent = `$${results.netProfitForInvestor.toFixed(2)}`;
            terminalPaymentResult.textContent = `$${results.terminalPayment.toFixed(2)}`; 
            
            // Populate Buyout Schedule Table
            buyoutScheduleTableBody.innerHTML = ''; 
            results.buyoutSchedule.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.year}</td>
                    <td>$${item.value.toFixed(2)}</td>
                `;
                buyoutScheduleTableBody.appendChild(row);
            });

            // Populate Customer Financials
            totalCustomerGridCostNoSolarResult.textContent = `$${results.totalCustomerGridCostNoSolar.toFixed(2)}`;
            totalSolarPPACostForCustomerResult.textContent = `$${results.totalSolarPPACostForCustomer.toFixed(2)}`;
            totalCustomerGridCostWithSolarResult.textContent = `$${results.totalCustomerGridCostWithSolar.toFixed(2)}`;
            totalSavingsForCustomerResult.textContent = `$${results.totalSavingsForCustomer.toFixed(2)}`;
            averageAnnualSavingsForCustomerResult.textContent = `$${results.averageAnnualSavingsForCustomer.toFixed(2)}`;
            savingsPerKwhForCustomerResult.textContent = `$${results.savingsPerKwhForCustomer.toFixed(3)}/kWh`;
            percentageSavedPerKwhForCustomerResult.textContent = `${results.percentageSavedPerKwhForCustomer.toFixed(2)}%`; 
            totalCustomerExportRevenueResult.textContent = `$${results.totalCustomerExportRevenue.toFixed(2)}`; 

            // Destroy existing chart instance if it exists
            if (cashFlowChart) {
                cashFlowChart.destroy();
            }

            // Create a new chart instance for investor cash flow
            cashFlowChart = new Chart(cashFlowChartCanvas, {
                type: 'bar', // Bar chart for annual cash flow
                data: {
                    labels: results.chartLabels,
                    datasets: [{
                        label: 'Projected Annual Investor Net Cash Flow ($)',
                        data: results.annualNetCashFlowData,
                        backgroundColor: (context) => {
                            const value = context.raw;
                            return value >= 0 ? 'rgba(59, 130, 246, 0.6)' : 'rgba(239, 68, 68, 0.6)';
                        },
                        borderColor: (context) => {
                            const value = context.raw;
                            return value >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(239, 68, 68, 1)';
                        },
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Net Cash Flow ($)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return `$${value.toLocaleString()}`;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'PPA Year',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                               
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `$${context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Calls the Gemini API to get insights based on the calculated project financials.
         */
        async function getProjectInsights() {
            insightsOutput.innerHTML = '<p class="text-center text-gray-500">Generating insights... Please wait.</p>'; // Loading indicator
            insightsOutput.classList.remove('text-red-500'); // Clear any previous error styling

            try {
                // Recalculate to get the latest numbers
                const results = calculatePPADetails();

                const prompt = `Analyze the following solar PPA project financials from an investor's perspective and provide a concise, qualitative summary of its viability. Highlight key strengths and weaknesses.
                Project Name: ${results.projectName}
                Date: ${results.projectDate}
                Project IRR: ${results.projectIRR.toFixed(2)}%
                Investor ROI: ${results.investorROI.toFixed(2)}%
                Net Present Value (NPV): $${results.netPresentValue.toFixed(2)}
                Payback Period: ${results.paybackPeriod}
                Levelized Cost of Energy (LCOE): $${results.lcoe.toFixed(3)}/kWh
                Initial Total Investment: $${results.initialTotalInvestment.toFixed(2)}
                Net Profit for Investor: $${results.netProfitForInvestor.toFixed(2)}
                Terminal Payment: $${results.terminalPayment.toFixed(2)}
                Customer Total Savings: $${results.totalSavingsForCustomer.toFixed(2)}
                Customer Average Annual Savings: $${results.averageAnnualSavingsForCustomer.toFixed(2)}
                Customer Savings per kWh: $${results.savingsPerKwhForCustomer.toFixed(3)}/kWh
                Customer Percentage Saved per kWh: ${results.percentageSavedPerKwhForCustomer.toFixed(2)}%
                Customer Total Export Revenue: $${results.totalCustomerExportRevenue.toFixed(2)}
                Investor Year 1 Net Return: $${results.year1NetReturn.toFixed(2)}
                Investor Year 1 Return Percentage: ${results.year1ReturnPercentage.toFixed(2)}%
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); // Use await here
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    insightsOutput.innerHTML = `<p>${text}</p>`;
                } else {
                    insightsOutput.innerHTML = '<p class="text-red-500">Error: Could not retrieve insights. Unexpected API response structure.</p>';
                    console.error("Unexpected API response structure:", result);
                }
            } catch (error) {
                insightsOutput.innerHTML = `<p class="text-red-500">Error: Failed to generate insights. ${error.message}</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }


        // Event listener for the calculate button
        calculateBtn.addEventListener('click', () => {
            const results = calculatePPADetails();
            displayResults(results);
        });

        // Event listener for the print buttons
        printFullReportBtn.addEventListener('click', () => {
            // Add a class to body to trigger full report print styles
            document.body.classList.add('print-full-report');
            window.print();
            // Remove the class after printing (or a short delay)
            setTimeout(() => {
                document.body.classList.remove('print-full-report');
            }, 500); 
        });

        printCustomerReportBtn.addEventListener('click', () => {
            // Add a class to body to trigger customer report print styles
            document.body.classList.add('print-customer-report');
            window.print();
            // Remove the class after printing (or a short delay)
            setTimeout(() => {
                document.body.classList.remove('print-customer-report');
            }, 500);
        });


        // Event listener for the Get Insights button
        getInsightsBtn.addEventListener('click', getProjectInsights); 

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTodayDate(); 
            // Clear existing dynamic cost entries before adding defaults
            dynamicOtherCostsContainer.innerHTML = '';
            // Add initial dynamic cost entries
            renderOtherAnnualCostRow({ id: 1, type: 'fixed', value: 1000, label: 'Roof Rental' });
            renderOtherAnnualCostRow({ id: 2, type: 'per_kwh_sold', value: 0.005, label: 'Partners Fee' });
            renderOtherAnnualCostRow({ id: 3, type: 'fixed', value: 200, label: 'Metering Fees' });
            
            // Set terminal payment default to last buyout value
            // This needs to be done AFTER the buyout schedule is calculated once.
            const initialResults = calculatePPADetails();
            const lastBuyout = initialResults.buyoutSchedule.length > 0 ? initialResults.buyoutSchedule[initialResults.buyoutSchedule.length - 1].value : 0;
            const terminalPaymentInput = document.getElementById('terminalPayment'); 
            if (terminalPaymentInput) {
                terminalPaymentInput.value = lastBuyout.toFixed(2);
            }

            // Directly call calculate and display after DOM is loaded and initial dynamic elements are rendered
            displayResults(initialResults);
        });

    </script>
</body>
</html>

